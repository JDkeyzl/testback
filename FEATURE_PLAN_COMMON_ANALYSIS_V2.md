# 前N名股票共同点分析功能规划 V2.0

## 📋 功能概述

基于**基准日**（大浪淘沙开始日期的前一天）的数据，分析筛选出的前N名股票的共同特征，帮助用户发现优质股票的买入时点规律。

## 🎯 核心概念

### 基准日定义
- **基准日** = 大浪淘沙开始日期的前一天
- **作用**：分析这些优质股票在启动前的共同技术特征
- **意义**：找到最佳买入时点的共同规律

### 分析逻辑
```
时间轴：
基准日（前一天） ← 分析这个时点的特征
开始日期（第1天） ← 大浪淘沙开始日期
结束日期（最后一天） ← 大浪淘沙结束日期

分析内容：
在基准日这一天，这些优质股票有哪些共同的技术特征？
```

## 📊 分析维度（基于基准日数据）

### 1. MACD 日线周线共振分析 ⭐

#### 1.1 日线MACD状态
- **DIF值**：快线-慢线，统计范围（最小/最大/平均/中位数）
- **DEA值**：信号线，统计范围
- **Hist值**：柱状图值（DIF-DEA），统计范围
- **柱状图颜色**：红色(>0) / 绿色(≤0) 的占比
- **柱状图趋势**：上升/下降/持平的占比
- **零轴位置**：DIF在零轴上方/下方/附近的占比

#### 1.2 周线MACD状态
- **DIF值**：统计范围
- **DEA值**：统计范围
- **Hist值**：统计范围
- **柱状图颜色**：红色/绿色的占比
- **柱状图趋势**：上升/下降/持平的占比

#### 1.3 共振分析
- **日线+周线同向**：都向上/都向下/同向的占比
- **日线+周线都红柱**：占比
- **日线+周线都上升**：占比
- **共振强度**：统计共振股票的数量和占比

**展示方式**：
- 统计表格：各项指标的分布范围
- 饼图：柱状图颜色分布、趋势分布
- 柱状图：共振类型分布

---

### 2. 基准价格与MA均线关系分析 ⭐

#### 2.1 价格与MA关系
- **价格 > MA5**：占比
- **价格 > MA10**：占比
- **价格 > MA20**：占比
- **价格 > MA30**：占比
- **价格 > MA60**：占比
- **价格 > MA120**：占比

#### 2.2 MA均线排列
- **多头排列**：MA5 > MA10 > MA20 > MA30 的占比
- **空头排列**：MA5 < MA10 < MA20 < MA30 的占比
- **均线粘合**：MA5与MA20差距<3% 的占比

#### 2.3 价格相对MA位置
- **价格在MA上方距离**：统计范围（最小/最大/平均）
- **价格在MA下方距离**：统计范围
- **价格突破MA**：刚突破/在MA上方/在MA下方的占比

**展示方式**：
- 统计表格：各项关系的占比
- 柱状图：价格与各MA的关系分布
- 饼图：均线排列类型分布

---

### 3. 过去N日内的价格位置分析 ⭐

#### 3.1 价格位置计算
- **回看周期**：可配置（默认60天）
- **价格位置**：当前价格在过去N日内的百分位（0-100%）
- **统计项**：
  - 价格位置范围：最小/最大/平均/中位数
  - 价格位置分布：<20%（底部）/ 20-40% / 40-60% / 60-80% / >80%（高位）

#### 3.2 价格区间分析
- **底部启动**：价格位置<30% 的占比
- **主升浪初期**：价格位置30-60% 的占比
- **高位**：价格位置>60% 的占比

#### 3.3 价格波动范围
- **过去N日最高价**：统计范围
- **过去N日最低价**：统计范围
- **价格波动幅度**：统计范围

**展示方式**：
- 统计表格：价格位置范围
- 柱状图：价格位置分布
- 饼图：价格区间类型分布

---

### 4. 放量关系分析 ⭐

#### 4.1 基准日成交量特征
- **成交量倍数**：基准日成交量 / 过去N日均量
- **统计项**：最小/最大/平均/中位数
- **放量分布**：
  - <1倍（缩量）：占比
  - 1-1.5倍（正常）：占比
  - 1.5-2倍（温和放量）：占比
  - 2-3倍（明显放量）：占比
  - >3倍（巨量）：占比

#### 4.2 成交量趋势
- **连续放量天数**：统计范围
- **放量趋势**：上升/下降/持平的占比
- **量价关系**：
  - 价涨量增：占比
  - 价跌量缩：占比
  - 价涨量缩：占比
  - 价跌量增：占比

#### 4.3 成交量健康度
- **上涨日平均成交量**：统计范围
- **下跌日平均成交量**：统计范围
- **量比**：上涨日平均量 / 下跌日平均量，统计范围

**展示方式**：
- 统计表格：成交量倍数范围
- 柱状图：放量倍数分布
- 饼图：量价关系类型分布

---

### 5. 其他量价维度（补充）✨

#### 5.1 价格动量指标
- **RSI相对强弱指标**：
  - RSI值范围：最小/最大/平均/中位数
  - RSI区间分布：<30（超卖）/ 30-50 / 50-70 / >70（超买）
  - 超买超卖占比

- **价格变化率**：
  - 过去5日涨跌幅：统计范围
  - 过去10日涨跌幅：统计范围
  - 过去20日涨跌幅：统计范围
  - 短期/中期/长期趋势一致性

#### 5.2 成交量动量指标
- **成交量变化率**：
  - 过去5日成交量变化：统计范围
  - 过去10日成交量变化：统计范围
  - 成交量趋势：上升/下降/持平占比

- **量能强度**：
  - 量比（当前量/均量）：统计范围
  - 量能分布：低量/正常/放量/巨量占比

#### 5.3 技术形态特征
- **K线形态**：
  - 阳线/阴线占比
  - 实体大小：统计范围
  - 上影线/下影线长度：统计范围

- **价格形态**：
  - 突破形态：突破前高/前低占比
  - 整理形态：横盘/上升/下降占比
  - 反转形态：占比

#### 5.4 波动性指标
- **ATR真实波动幅度**：
  - ATR值范围：统计范围
  - 波动率：统计范围
  - 波动率分布：低波动/中波动/高波动占比

- **布林带位置**：
  - 价格在布林带上轨/中轨/下轨的占比
  - 布林带宽度：统计范围
  - 价格突破布林带：占比

#### 5.5 资金流向指标
- **换手率**：
  - 换手率范围：统计范围
  - 换手率分布：低换手/正常/高换手占比

- **成交额**：
  - 成交额范围：统计范围
  - 成交额分布：小盘/中盘/大盘占比

#### 5.6 趋势强度指标
- **ADX趋势强度**（可选）：
  - ADX值范围：统计范围
  - 趋势强度分布：弱趋势/中趋势/强趋势占比

- **价格斜率**：
  - 过去N日价格斜率：统计范围
  - 斜率方向：上升/下降/横盘占比

---

## 🏗️ 技术实现方案

### 1. 后端API设计

#### 1.1 API端点
```python
POST /api/v1/best-stocks/analyze-common-features
请求体：
{
  "symbols": ["600000", "600001", ...],  // 要分析的股票代码列表（从前N名获取）
  "startDate": "2024-01-15",  // 大浪淘沙开始日期
  "endDate": "2024-02-15",    // 大浪淘沙结束日期
  "topN": 10,                 // 分析前N名（如果symbols为空）
  "lookbackDays": 60          // 价格位置回看天数（默认60）
}

响应：
{
  "ok": true,
  "baseDate": "2024-01-14",  // 基准日
  "analysis": {
    "macdResonance": {
      "daily": {
        "dif": {"min": -0.05, "max": 0.15, "avg": 0.08, "median": 0.09},
        "dea": {"min": -0.03, "max": 0.12, "avg": 0.06, "median": 0.07},
        "hist": {"min": -0.02, "max": 0.08, "avg": 0.03, "median": 0.03},
        "histColor": {"red": 8, "green": 2},  // 红色柱占比80%
        "histTrend": {"up": 7, "down": 2, "neutral": 1},
        "zeroAxis": {"above": 6, "below": 3, "near": 1}
      },
      "weekly": {
        "dif": {...},
        "dea": {...},
        "hist": {...},
        "histColor": {"red": 9, "green": 1},
        "histTrend": {"up": 8, "down": 1, "neutral": 1}
      },
      "resonance": {
        "bothUp": 7,      // 日线周线都向上
        "bothRed": 8,     // 日线周线都红柱
        "bothRising": 6,  // 日线周线都上升
        "sameDirection": 9  // 同向（都向上或都向下）
      }
    },
    "priceMARelation": {
      "priceAboveMA": {
        "MA5": 10,   // 10只股票价格>MA5，占比100%
        "MA10": 9,
        "MA20": 8,
        "MA30": 7,
        "MA60": 6,
        "MA120": 5
      },
      "maAlignment": {
        "bullish": 7,  // 多头排列
        "bearish": 1,  // 空头排列
        "neutral": 2   // 均线粘合
      },
      "priceDistanceFromMA": {
        "aboveMA20": {"min": 0.5, "max": 5.2, "avg": 2.8},
        "belowMA20": {"min": 0, "max": 0, "avg": 0}
      }
    },
    "pricePosition": {
      "lookbackDays": 60,
      "positionRange": {"min": 15.2, "max": 45.8, "avg": 28.5, "median": 27.3},
      "positionDistribution": {
        "<20": 3,   // 底部
        "20-40": 4,
        "40-60": 2,
        "60-80": 1,
        ">80": 0
      },
      "priceRange": {
        "high60d": {"min": 12.5, "max": 58.3, "avg": 28.9},
        "low60d": {"min": 8.2, "max": 35.6, "avg": 18.2},
        "volatility": {"min": 15.2, "max": 45.8, "avg": 28.5}
      }
    },
    "volumeRelation": {
      "volumeRatio": {"min": 1.2, "max": 3.5, "avg": 2.1, "median": 2.0},
      "volumeDistribution": {
        "<1": 1,      // 缩量
        "1-1.5": 2,   // 正常
        "1.5-2": 3,   // 温和放量
        "2-3": 3,     // 明显放量
        ">3": 1       // 巨量
      },
      "volumeTrend": {"up": 7, "down": 2, "neutral": 1},
      "priceVolumeRelation": {
        "priceUpVolumeUp": 8,
        "priceDownVolumeDown": 1,
        "priceUpVolumeDown": 0,
        "priceDownVolumeUp": 1
      },
      "volumeHealth": {
        "avgVolumeUp": {"min": 1.5, "max": 3.2, "avg": 2.3},
        "avgVolumeDown": {"min": 0.8, "max": 1.5, "avg": 1.1},
        "volumeRatio": {"min": 1.2, "max": 2.8, "avg": 1.9}
      }
    },
    "otherIndicators": {
      "rsi": {
        "value": {"min": 35, "max": 65, "avg": 52, "median": 53},
        "distribution": {
          "<30": 1,   // 超卖
          "30-50": 3,
          "50-70": 5,
          ">70": 1    // 超买
        }
      },
      "priceMomentum": {
        "change5d": {"min": -2.5, "max": 8.5, "avg": 3.2},
        "change10d": {"min": -5.2, "max": 12.8, "avg": 5.8},
        "change20d": {"min": -8.5, "max": 18.2, "avg": 8.5}
      },
      "volumeMomentum": {
        "change5d": {"min": -10, "max": 50, "avg": 25},
        "change10d": {"min": -15, "max": 80, "avg": 35},
        "volumeRatio": {"min": 1.0, "max": 3.5, "avg": 2.1}
      },
      "klinePattern": {
        "yang": 7,    // 阳线
        "yin": 3,     // 阴线
        "bodySize": {"min": 0.5, "max": 5.2, "avg": 2.8}
      },
      "volatility": {
        "atr": {"min": 0.8, "max": 3.5, "avg": 2.1},
        "volatility": {"min": 12.5, "max": 28.5, "avg": 18.2},
        "distribution": {
          "low": 2,
          "medium": 6,
          "high": 2
        }
      },
      "turnover": {
        "rate": {"min": 1.2, "max": 8.5, "avg": 3.8},
        "distribution": {
          "low": 2,
          "normal": 5,
          "high": 3
        }
      },
      "trendStrength": {
        "slope20d": {"min": -0.05, "max": 0.15, "avg": 0.08},
        "direction": {"up": 8, "down": 1, "neutral": 1}
      }
    }
  },
  "summary": {
    "totalStocks": 10,
    "commonFeatures": [
      "80%的股票日线MACD为红柱",
      "90%的股票周线MACD为红柱",
      "70%的股票日线周线共振向上",
      "80%的股票价格>MA20",
      "70%的股票处于底部启动位置（价格位置<30%）",
      "60%的股票明显放量（1.5-3倍）",
      "80%的股票价涨量增"
    ]
  }
}
```

#### 1.2 后端实现逻辑
```python
位置：backend/app/api/backtest.py

函数：analyze_common_features_base_date(symbols, startDate, endDate, lookbackDays)
流程：
1. 计算基准日 = startDate - 1天
2. 对每个股票：
   a. 加载日线数据（到基准日）
   b. 加载周线数据（到基准日所在周）
   c. 计算基准日的各项指标：
      - MACD（日线、周线）
      - MA均线（5/10/20/30/60/120）
      - 价格位置（过去N日）
      - 成交量倍数
      - RSI、价格动量、成交量动量等
3. 统计所有股票的指标分布
4. 计算共同特征
5. 返回分析结果
```

---

### 2. 前端实现

#### 2.1 UI组件
```jsx
位置：src/pages/BestStocksPage.jsx

新增组件：
- "分析共同点"按钮（在结果表格上方）
- 分析配置弹窗：
  - 选择前N名（默认10）
  - 价格位置回看天数（默认60）
- 分析结果展示卡片：
  - 基准日信息
  - 各维度分析结果
  - 共同特征总结
  - 统计图表
```

#### 2.2 状态管理
```javascript
const [analysisTopN, setAnalysisTopN] = useState(10)
const [lookbackDays, setLookbackDays] = useState(60)
const [showAnalysis, setShowAnalysis] = useState(false)
const [analysisResult, setAnalysisResult] = useState(null)
const [isAnalyzing, setIsAnalyzing] = useState(false)
```

#### 2.3 图表展示
- **饼图**：MACD柱状图颜色分布、趋势分布、共振类型、量价关系
- **柱状图**：价格与MA关系、价格位置分布、放量倍数分布、RSI分布
- **统计表格**：各项指标的详细统计（最小/最大/平均/中位数）

---

## 📊 展示界面设计

### 分析结果卡片布局
```
┌─────────────────────────────────────────────┐
│  前10名股票共同点分析（基准日：2024-01-14）  │
├─────────────────────────────────────────────┤
│                                             │
│  📅 基准日信息                              │
│  • 基准日：2024-01-14（开始日期前一天）     │
│  • 分析股票数：10只                         │
│                                             │
│  📊 MACD日线周线共振                       │
│  ┌─────────────────────────────────────┐   │
│  │ 日线MACD                             │   │
│  │ • 红柱占比：80%                      │   │
│  │ • 上升趋势：70%                      │   │
│  │ • DIF范围：-0.05 ~ 0.15 (平均0.08)  │   │
│  │ [饼图：柱状图颜色分布]              │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ 周线MACD                             │   │
│  │ • 红柱占比：90%                      │   │
│  │ • 上升趋势：80%                      │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ 共振分析                             │   │
│  │ • 日线周线都红柱：80%                │   │
│  │ • 日线周线都上升：60%                │   │
│  │ [饼图：共振类型分布]                │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  📈 基准价格与MA均线关系                   │
│  ┌─────────────────────────────────────┐   │
│  │ 价格>MA关系                          │   │
│  │ • 价格>MA5：100% (10只)              │   │
│  │ • 价格>MA20：80% (8只)               │   │
│  │ • 价格>MA60：60% (6只)               │   │
│  │ [柱状图：价格与各MA关系]            │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ 均线排列                             │   │
│  │ • 多头排列：70%                      │   │
│  │ • 空头排列：10%                      │   │
│  │ [饼图：均线排列类型]                │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  📍 过去60日价格位置                       │
│  ┌─────────────────────────────────────┐   │
│  │ 价格位置范围：15.2% ~ 45.8%         │   │
│  │ 平均位置：28.5%                     │   │
│  │ • 底部(<20%)：30%                   │   │
│  │ • 中低位(20-40%)：40%               │   │
│  │ • 中位(40-60%)：20%                 │   │
│  │ [柱状图：价格位置分布]              │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  📊 放量关系                               │
│  ┌─────────────────────────────────────┐   │
│  │ 成交量倍数：1.2 ~ 3.5倍 (平均2.1倍) │   │
│  │ • 明显放量(2-3倍)：30%              │   │
│  │ • 温和放量(1.5-2倍)：30%            │   │
│  │ [柱状图：放量倍数分布]              │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ 量价关系                             │   │
│  │ • 价涨量增：80%                      │   │
│  │ • 价跌量缩：10%                      │   │
│  │ [饼图：量价关系类型]                │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  🔍 其他量价维度                           │
│  ┌─────────────────────────────────────┐   │
│  │ RSI相对强弱                          │   │
│  │ • RSI范围：35 ~ 65 (平均52)         │   │
│  │ • 正常区间(50-70)：50%              │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ 价格动量                              │   │
│  │ • 过去5日涨跌：-2.5% ~ 8.5%         │   │
│  │ • 过去20日涨跌：-8.5% ~ 18.2%       │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ 波动性                                │   │
│  │ • ATR范围：0.8 ~ 3.5 (平均2.1)      │   │
│  │ • 中波动：60%                        │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ⭐ 共同特征总结                          │
│  ┌─────────────────────────────────────┐   │
│  │ 1. 80%的股票日线MACD为红柱          │   │
│  │ 2. 90%的股票周线MACD为红柱          │   │
│  │ 3. 70%的股票日线周线共振向上        │   │
│  │ 4. 80%的股票价格>MA20               │   │
│  │ 5. 70%的股票处于底部启动位置         │   │
│  │ 6. 60%的股票明显放量(1.5-3倍)       │   │
│  │ 7. 80%的股票价涨量增                │   │
│  └─────────────────────────────────────┘   │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 🔧 实现步骤

### Phase 1: 核心功能
1. ⬜ 实现基准日计算逻辑
2. ⬜ 实现MACD日线周线共振分析
3. ⬜ 实现价格与MA均线关系分析
4. ⬜ 实现价格位置分析
5. ⬜ 实现放量关系分析

### Phase 2: 补充维度
1. ⬜ 实现RSI分析
2. ⬜ 实现价格动量分析
3. ⬜ 实现成交量动量分析
4. ⬜ 实现波动性分析
5. ⬜ 实现其他量价指标

### Phase 3: 前端展示
1. ⬜ 添加"分析共同点"按钮
2. ⬜ 实现分析配置弹窗
3. ⬜ 实现分析结果展示卡片
4. ⬜ 集成图表库展示统计结果
5. ⬜ 实现共同特征总结

### Phase 4: 增强功能
1. ⬜ 导出分析报告
2. ⬜ 对比不同N值的分析结果
3. ⬜ 历史分析记录

---

## 📝 技术细节

### 1. MACD计算
```python
# 日线MACD
daily_df = load_stock_data(symbol, timeframe='1d', end_date=base_date)
ema_fast = daily_df['close'].ewm(span=12, adjust=False).mean()
ema_slow = daily_df['close'].ewm(span=26, adjust=False).mean()
dif = ema_fast - ema_slow
dea = dif.ewm(span=9, adjust=False).mean()
hist = dif - dea

# 周线MACD
weekly_df = load_stock_data(symbol, timeframe='1w', end_date=base_date)
# 同样计算
```

### 2. MA均线计算
```python
ma5 = df['close'].rolling(window=5).mean()
ma10 = df['close'].rolling(window=10).mean()
ma20 = df['close'].rolling(window=20).mean()
ma30 = df['close'].rolling(window=30).mean()
ma60 = df['close'].rolling(window=60).mean()
ma120 = df['close'].rolling(window=120).mean()
```

### 3. 价格位置计算
```python
# 基准日价格
base_price = df.loc[base_date, 'close']

# 过去N日价格
lookback_df = df[df.index <= base_date].tail(lookback_days)
min_price = lookback_df['close'].min()
max_price = lookback_df['close'].max()

# 价格位置（百分位）
price_position = ((base_price - min_price) / (max_price - min_price)) * 100
```

### 4. 成交量倍数计算
```python
# 基准日成交量
base_volume = df.loc[base_date, 'volume']

# 过去N日均量
avg_volume = df[df.index <= base_date].tail(lookback_days)['volume'].mean()

# 成交量倍数
volume_ratio = base_volume / avg_volume if avg_volume > 0 else 0
```

### 5. RSI计算
```python
def calculate_rsi(prices, period=14):
    delta = prices.diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=period).mean()
    rs = gain / loss
    rsi = 100 - (100 / (1 + rs))
    return rsi
```

---

## ❓ 待确认问题

1. **回看天数**：价格位置分析的回看天数默认60天，是否需要可配置？
2. **MA周期**：是否需要支持自定义MA周期（如MA13、MA21等）？
3. **RSI周期**：RSI计算周期默认14，是否需要可配置？
4. **图表类型**：是否需要更多图表类型（如热力图、雷达图）？
5. **共同特征阈值**：多少占比算"共同特征"？（建议：≥60%）
6. **导出格式**：需要支持哪些导出格式（PDF、Excel、CSV）？
7. **对比功能**：是否需要对比不同时间段的分析结果？

---

**请确认以上方案是否符合您的需求，特别是：**
- ✅ 基准日的定义和使用
- ✅ 分析维度的完整性
- ✅ 补充的量价维度是否合适
- ✅ 展示方式是否清晰易懂

